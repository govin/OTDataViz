<!DOCTYPE html>
<html>
	<head>
		<title>Reservation Map</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<style type="text/css">
			html {
				 height: 100%
			}

			body {
				 height: 100%; margin: 0; padding: 0
			}

			#map-canvas {
				 height: 100%;
				position: relative;
			}

			#header {
				height: 100px;
				min-height: 75px;
				position: absolute;
				z-index: 1;
				background-color: white;
				width: 100%;
				opacity: .7;
			}

			.headerMessage {
				display: block;
				text-align: left;
				font-size: 2em;
				font-family: monospace;
				padding-top: 30px;
				padding-left: 249px;
				font-weight: bold;
			}

			.logo {
				height: 100%;
				width: 100%;
				background-image: url(Content/img/Logo.png);
				background-position: left;
				background-repeat: no-repeat;
				float: left;
				opacity: 1;
				border-bottom: solid 1px red;
			}

			.delayMessage {
				display: block;
				width: 100%;
				opacity: 1;
				text-align: right;
				padding-top: 22px;
				font-size: .7em;
			}

		</style>
		
		
	</head>
	<body>
		<div id="header">
			<div class="logo">
				<span class="headerMessage">Reservations By The Minute</span>
				<span class="delayMessage">*delayed by 2-5 minutes</span>
			</div>
			<div id="list"></div>
		</div>
		<div id="map-canvas"/>
		
		<script type="text/javascript" src="Scripts/jquery-1.9.1.js"></script>
		<script type="text/javascript" src="Scripts/jquery.mockjson.js"></script>
		<script type="text/javascript"
				src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbZCTMWJsQWIIrJreyd2ly2AzsOusVtfs&sensor=false">
		</script>
		
		<script type="text/javascript">
			var map;
			var lat = 38.7;
			var lon = -9.18;
			var zoom = 3;
			
			function loadNAReservations() {
				var naUpdate = 0;
				$.getJSON('api/LiveResoFeedNA', function (data) {
					var reservations = data;
					var firstDateMade = new Date(reservations[0].DateMadeUtc + "Z");
					var lastDateMade = new Date(reservations[reservations.length - 1].DateMadeUtc + "Z");
					naUpdate = firstDateMade.getTime() - lastDateMade.getTime();
					animate(reservations);
				});
				
				if (naUpdate < 60000)
					naUpdate = 60000;
				window.setTimeout(function () {
					loadNAReservations();
				}, naUpdate - 500);
			};
			
			function loadJPReservations() {
				var jpUpdate = 0;
				$.getJSON('api/LiveResoFeedJP', function (data) {
					var reservations = data;
					var firstDateMade = new Date(reservations[0].DateMadeUtc + "Z");
					var lastDateMade = new Date(reservations[reservations.length - 1].DateMadeUtc + "Z");
					jpUpdate = firstDateMade.getTime() - lastDateMade.getTime();
					animate(reservations);
				});

				if (jpUpdate < 60000)
					jpUpdate = 60000;
				window.setTimeout(function () {
					loadJPReservations();
				}, jpUpdate - 500);
			};
			
			function loadEUReservations() {
				var euUpdate = 0;
				$.getJSON('api/LiveResoFeedEU', function (data) {
					var reservations = data;
					var firstDateMade = new Date(reservations[0].DateMadeUtc + "Z");
					var lastDateMade = new Date(reservations[reservations.length - 1].DateMadeUtc + "Z");
					euUpdate = firstDateMade.getTime() - lastDateMade.getTime();
					animate(reservations);
				});
				
				if (euUpdate < 60000)
					euUpdate = 60000;
				window.setTimeout(function () {
					loadEUReservations();
				}, euUpdate - 500);
			};

			function initializeMap() {

				setMapCoordinates();
				
				var mapOptions = {
					center: new google.maps.LatLng(lat, lon),
					zoom: zoom,
					mapTypeId: google.maps.MapTypeId.TERRAIN,
					streetViewControl: false,
					mapTypeControl: false,
					zoomControl: true,
					zoomControlOptions: {
						position: google.maps.ControlPosition.LEFT_BOTTOM
					},
					panControl: true,
					panControlOptions: {
						position: google.maps.ControlPosition.LEFT_BOTTOM
					},
					scaleControl: false
				};
				map = new google.maps.Map(document.getElementById("map-canvas"),
					mapOptions);
			}
			
			function setMapCoordinates() {
				var lang = navigator.language;
				var width = $("body").width();
				
				if (width < 1825) {
					switch (lang.toLowerCase()) {
						case "en-gb":
						case "de-de":
							lat = 53.81;
							lon = 4.43;
							zoom = 6;
							break;
						case "ja-jp":
							lat = 39.41;
							lon = 136;
							zoom = 6;
							break;
						default:
							lat = 48.17;
							lon = -100.17;
							zoom = 4;
							break;
					}
				}
			}
			
			function animate(reservations) {
				var firstDateMade;
				var times = [];
				if(reservations.length > 0)
					firstDateMade = new Date(reservations[0].DateMadeUtc + "Z");
				for (var index = 0, length = reservations.length; index < length; index++) {
					var dateMade = new Date(reservations[index].DateMadeUtc + "Z");
					var timeElapsedMs = firstDateMade.getTime() - dateMade.getTime();
					times.push(timeElapsedMs);
				}
				
				for (var i = 0, l = reservations.length; i < l; i++) {
					doSetTimeout(reservations[i], times[i]);
				}
				
				for(var j = 0; j < times.length; j++) {
					console.log(times[j]);
				}
			}
			
			function doSetTimeout(reso, time) {
				setTimeout(function () { placeMarker(reso); }, time);
			}
			
			function placeMarker(reso) {
				var myLatlng = new google.maps.LatLng(reso.Latitude, reso.Longitude);
				var image = {
					url: 'Content/img/1364380262_onebit_09.png',
					size: new google.maps.Size(48, 48),
					origin: new google.maps.Point(0, 0),
					anchor: new google.maps.Point(10, 48)
				};
				var marker = new google.maps.Marker({
					position: myLatlng,
					map: map,
					icon: image,
					title: reso.RestaurantName
				});

				window.setTimeout(function () { marker.setMap(null);}, 3000);
			}

			$(document).ready(function () {
				initializeMap();

				window.setTimeout(function() {
					loadNAReservations();
				}, 0);
				window.setTimeout(function() {
					loadEUReservations();
				}, 1000);
				window.setTimeout(function() {
					loadJPReservations();
				}, 1500);
			});

		</script>
	</body>
</html>